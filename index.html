<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª…ë³´ê¸°ì—…ãˆœ ì›ì¬ë£Œ ì¬ê³  ì´ì›” ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS (ë””ìì¸) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse (CSV ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <div class="max-w-4xl mx-auto py-10 px-5">
        <!-- í—¤ë” -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">ì›ì¬ë£Œ ìˆ˜ë¶ˆë¶€ ìë™ ì´ì›” ì‹œìŠ¤í…œ (V3 - ê¸ˆì•¡ í•©ê³„ ë³´ì •íŒ)</h1>
            <p class="text-slate-500">ì¤‘ë³µ ë°ì´í„° ëˆ„ì  í•©ì‚° ë° í’ˆë²ˆ/ìì¬ëª… êµì°¨ ë§¤ì¹­ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- 2024ë…„ íŒŒì¼ ì—…ë¡œë“œ -->
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition-colors">
                    <h2 class="text-lg font-semibold text-slate-700 mb-4">ğŸ“‚ 2024ë…„ ì›ì¬ë£Œ ìˆ˜ë¶ˆë¶€</h2>
                    <input type="file" id="file2024" accept=".csv" class="hidden" />
                    <label for="file2024" class="cursor-pointer bg-blue-100 text-blue-700 px-4 py-2 rounded-md font-medium hover:bg-blue-200 transition-colors">
                        íŒŒì¼ ì„ íƒ
                    </label>
                    <p id="name2024" class="mt-3 text-sm text-slate-500 truncate">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p>
                </div>

                <!-- 2025ë…„ íŒŒì¼ ì—…ë¡œë“œ -->
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition-colors">
                    <h2 class="text-lg font-semibold text-slate-700 mb-4">ğŸ“‚ 2025ë…„ ì›ì¬ë£Œ ìˆ˜ë¶ˆë¶€ (ì–‘ì‹)</h2>
                    <input type="file" id="file2025" accept=".csv" class="hidden" />
                    <label for="file2025" class="cursor-pointer bg-blue-100 text-blue-700 px-4 py-2 rounded-md font-medium hover:bg-blue-200 transition-colors">
                        íŒŒì¼ ì„ íƒ
                    </label>
                    <p id="name2025" class="mt-3 text-sm text-slate-500 truncate">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</p>
                </div>
            </div>

            <!-- ì˜µì…˜ ì„¤ì • -->
            <div class="mb-8 p-4 bg-amber-50 rounded-lg border border-amber-200">
                <h3 class="font-semibold text-amber-800 mb-2">âš™ï¸ ì²˜ë¦¬ ì„¤ì •</h3>
                <div class="flex items-center gap-4">
                    <label class="text-sm font-medium text-slate-700">ì¸ì½”ë”© ë°©ì‹:</label>
                    <select id="encoding" class="border border-slate-300 rounded-md px-3 py-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="EUC-KR">EUC-KR (ì¼ë°˜ì ì¸ ì—‘ì…€ CSV)</option>
                        <option value="UTF-8">UTF-8 (UTF-8 ì—‘ì…€ CSV)</option>
                    </select>
                </div>
            </div>

            <!-- ì‹¤í–‰ ë²„íŠ¼ -->
            <div class="text-center">
                <button id="processBtn" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors">
                    ğŸš€ ë°ì´í„° ì´ì›” ë° ë‹¤ìš´ë¡œë“œ
                </button>
            </div>

            <!-- ë¡œê·¸ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="logArea" class="mt-6 hidden">
                <div class="p-4 rounded-lg bg-slate-100 border border-slate-200 text-sm h-48 overflow-y-auto font-mono text-slate-700" id="logContent">
                    <!-- ë¡œê·¸ ì¶œë ¥ -->
                </div>
            </div>

        </div>

        <!-- ì•ˆë‚´ ì‚¬í•­ -->
        <div class="mt-8 text-sm text-slate-500 bg-white rounded-lg shadow p-6">
            <h3 class="font-bold text-slate-700 mb-2">ğŸ“Œ ì‹œìŠ¤í…œ ë°˜ì˜ ë¡œì§ (V3 ì—…ë°ì´íŠ¸ ì‚¬í•­)</h3>
            <ul class="list-disc pl-5 space-y-1">
                <li><b>ë°ì´í„° ëˆ„ì  í•©ì‚°:</b> 2024ë…„ íŒŒì¼ì— ë™ì¼í•œ í’ˆëª©ì´ ì—¬ëŸ¬ ì¤„ ìˆì„ ê²½ìš°, ê¸ˆì•¡ê³¼ ìˆ˜ëŸ‰ì´ ë®ì–´ì“°ì´ì§€ ì•Šê³  ì•ˆì „í•˜ê²Œ <b>í•©ì‚°(+)</b>ë©ë‹ˆë‹¤.</li>
                <li><b>êµì°¨ ë§¤ì¹­ ê¸°ëŠ¥:</b> 2025ë…„ ë°ì´í„°ì˜ í’ˆë²ˆ/ìì¬ëª… ì—´ ìœ„ì¹˜ê°€ ë°”ë€Œì–´ ìˆì–´ë„ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ì—¬ ë§¤ì¹­í•©ë‹ˆë‹¤.</li>
                <li>í’ˆëª©ì€ ë™ì¼í•˜ì§€ë§Œ 2025ë…„ ë‹¹ê¸°ì…ê³  ë‹¨ê°€ì™€ 2024ë…„ ê¸°ë§ ë‹¨ê°€ê°€ ë‹¤ë¥´ê±°ë‚˜, ì¼ì¹˜í•˜ëŠ” í’ˆëª©ì´ ì•„ì˜ˆ ì—†ë‹¤ë©´ ë§¨ ì•„ë˜ì— <b>ìƒˆë¡œìš´ í–‰ì„ ì¶”ê°€</b>í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œ
        const file24Input = document.getElementById('file2024');
        const file25Input = document.getElementById('file2025');
        const name24 = document.getElementById('name2024');
        const name25 = document.getElementById('name2025');
        const processBtn = document.getElementById('processBtn');
        const encodingSelect = document.getElementById('encoding');
        const logArea = document.getElementById('logArea');
        const logContent = document.getElementById('logContent');

        // íŒŒì¼ ì´ë¦„ í‘œì‹œ
        file24Input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) name24.textContent = "âœ… " + e.target.files[0].name;
            else name24.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
        });

        file25Input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) name25.textContent = "âœ… " + e.target.files[0].name;
            else name25.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
        });

        function log(message, isError = false) {
            logArea.classList.remove('hidden');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) p.classList.add('text-red-600', 'font-bold');
            logContent.appendChild(p);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function parseCSV(file, encoding) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    encoding: encoding,
                    skipEmptyLines: false,
                    complete: function(results) { resolve(results.data); },
                    error: function(err) { reject(err); }
                });
            });
        }

        processBtn.addEventListener('click', async () => {
            const file24 = file24Input.files[0];
            const file25 = file25Input.files[0];

            if (!file24 || !file25) {
                alert("2024ë…„ ë° 2025ë…„ CSV íŒŒì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            processBtn.disabled = true;
            processBtn.textContent = "ì²˜ë¦¬ ì¤‘...";
            logContent.innerHTML = ""; 

            try {
                const encoding = encodingSelect.value;
                log("ë°ì´í„° ë¶„ì„ ì‹œì‘...");

                const data24 = await parseCSV(file24, encoding);
                const data25 = await parseCSV(file25, encoding);

                let output25 = [...data25]; 
                let maxCols = output25[3] ? output25[3].length : 20;

                let updateCount = 0;
                let addCount = 0;
                let totalAccumulatedAmt = 0;

                // 2024ë…„ ê¸°ë§ì¬ê³  í™•ì¸ (4ë²ˆì§¸ ì¤„ë¶€í„° ë°ì´í„° ì‹œì‘)
                for (let i = 4; i < data24.length; i++) {
                    const row24 = data24[i];
                    if (!row24 || row24.length < 15 || (!row24[0] && !row24[1])) continue;

                    const code24 = String(row24[0] || "").trim();
                    const name24 = String(row24[1] || "").trim();
                    const spec24 = String(row24[2] || "").trim();
                    
                    const endQty = parseFloat(String(row24[12] || "0").replace(/,/g, '').replace(/-/g, '0')) || 0;
                    const endPrice = parseFloat(String(row24[13] || "0").replace(/,/g, '').replace(/-/g, '0')) || 0;
                    const endAmt = parseFloat(String(row24[14] || "0").replace(/,/g, '').replace(/-/g, '0')) || 0;

                    // ê¸°ë§ ìˆ˜ëŸ‰ì´ë‚˜ ê¸ˆì•¡ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                    if (endQty > 0 || endAmt > 0) {
                        let isItemFound = false;
                        let targetIndex = -1;

                        // 2025ë…„ íŒŒì¼ ë‚´ì—ì„œ ê²€ìƒ‰
                        for (let j = 4; j < output25.length; j++) {
                            const r25 = output25[j];
                            if (!r25 || r25.length < 3) continue;

                            const code25 = String(r25[0] || "").trim();
                            const name25 = String(r25[1] || "").trim();
                            const spec25 = String(r25[2] || "").trim();
                            const inPrice25 = parseFloat(String(r25[7] || "0").replace(/,/g, '').replace(/-/g, '0')) || 0;

                            // 1. ì •ìƒ ë§¤ì¹­ ë˜ëŠ” í’ˆë²ˆ-ìì¬ëª… ìœ„ì¹˜ê°€ ë°”ë€ êµì°¨ ë§¤ì¹­ í—ˆìš©
                            const isNameMatched = (code24 === code25 && name24 === name25) || (code24 === name25 && name24 === code25);
                            const isSpecMatched = (spec24 === spec25);

                            if (isNameMatched && isSpecMatched) {
                                isItemFound = true;
                                // 2. ë‹¨ê°€ê¹Œì§€ ë™ì¼í•˜ê±°ë‚˜ 2025ë…„ ë‹¨ê°€ê°€ ë¹ˆì¹¸(0)ì¼ ê²½ìš° ë§¤ì¹­
                                if (endPrice === inPrice25 || inPrice25 === 0) {
                                    targetIndex = j;
                                    break; 
                                }
                            }
                        }

                        if (targetIndex !== -1) {
                            // ë¡œì§ 1: ì™„ë²½ ì¼ì¹˜ -> [ë®ì–´ì“°ê¸°ê°€ ì•„ë‹Œ ê¸ˆì•¡/ìˆ˜ëŸ‰ ëˆ„ì  í•©ì‚°]
                            const prevQty = parseFloat(String(output25[targetIndex][3] || "0").replace(/,/g, '')) || 0;
                            const prevAmt = parseFloat(String(output25[targetIndex][5] || "0").replace(/,/g, '')) || 0;

                            output25[targetIndex][3] = prevQty + endQty;
                            output25[targetIndex][4] = endPrice; 
                            output25[targetIndex][5] = prevAmt + endAmt;

                            // ë¹ˆì¹¸ì´ì—ˆë˜ 2025ë…„ ë‹¹ê¸°ì…ê³ ë‹¨ê°€ë¥¼ ì±„ì›Œì£¼ì–´, ë‹¤ìŒë²ˆì— ë‹¤ë¥¸ ë‹¨ê°€ê°€ ì˜¤ë©´ ì‹ ê·œ í–‰ìœ¼ë¡œ ì¶”ê°€ë˜ë„ë¡ ë°©ì–´
                            if (parseFloat(String(output25[targetIndex][7] || "0").replace(/,/g, '')) === 0) {
                                output25[targetIndex][7] = endPrice;
                            }
                            
                            updateCount++;
                            totalAccumulatedAmt += endAmt;
                        } else {
                            // ë¡œì§ 2 & 3: ë™ì¼ í’ˆëª©ì´ë‚˜ ë‹¨ê°€ ë‹¤ë¦„ OR í’ˆëª© ì™„ì „ ì—†ìŒ -> ì‹ ê·œ í–‰ ìƒì„±
                            const newRow = new Array(maxCols).fill("");
                            newRow[0] = code24;
                            newRow[1] = name24;
                            newRow[2] = spec24;
                            newRow[3] = endQty;   // ê¸°ì´ˆ ìˆ˜ëŸ‰
                            newRow[4] = endPrice; // ê¸°ì´ˆ ë‹¨ê°€
                            newRow[5] = endAmt;   // ê¸°ì´ˆ ê¸ˆì•¡
                            newRow[7] = endPrice; // ì‹ ê·œ í–‰ì€ ë‹¹ê¸°ì…ê³  ë‹¨ê°€ë„ ê¸°ì¤€ ë‹¨ê°€ë¡œ ì„¸íŒ…
                            
                            output25.push(newRow);
                            addCount++;
                            totalAccumulatedAmt += endAmt;
                            
                            if (isItemFound) {
                                log(`ë‹¨ê°€ ë¶ˆì¼ì¹˜ë¡œ ì‹ ê·œ í–‰ ì¶”ê°€: ${name24} (ë‹¨ê°€: ${endPrice})`);
                            }
                        }
                    }
                }

                log(`ì‘ì—… ì™„ë£Œ! ê¸°ì¡´ í–‰ ì—…ë°ì´íŠ¸: ${updateCount}ê±´ / ì‹ ê·œ í–‰ ì¶”ê°€: ${addCount}ê±´`);
                log(`â€» ì´ì›” ì²˜ë¦¬ëœ ì´ ê¸°ì´ˆì¬ê³  ê¸ˆì•¡: ${totalAccumulatedAmt.toLocaleString()}ì›`);

                // CSV íŒŒì¼ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ
                const csvContent = Papa.unparse(output25);
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const downloadLink = document.createElement("a");
                downloadLink.setAttribute("href", url);
                downloadLink.setAttribute("download", "2025ë…„_ê¸°ì´ˆì¬ê³ _ì´ì›”ì™„ë£Œ(V3).csv");
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
            } catch (error) {
                console.error(error);
                log(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, true);
                alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n${error.message}`);
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = "ğŸš€ ë°ì´í„° ì´ì›” ë° ë‹¤ìš´ë¡œë“œ";
            }
        });
    </script>
</body>
</html>